






<!-- 


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Excel Mock Interviewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>AI-Powered Excel Mock Interviewer</h1>

        <!-- User Registration -->
 <!--  <div id="user-section" class="section">
            <h2>Register</h2>
            <input type="text" id="name" placeholder="Full Name">
            <input type="email" id="email" placeholder="Email">
            <input type="text" id="experience" placeholder="Experience (e.g. 2 years)">
            <input type="text" id="position" placeholder="Position (e.g. Data Analyst)">
            <button onclick="registerUser()">Register</button>
        </div>

         Interview Section 
        <div id="intro-container"></div>
        
         Candidate Introduction Section 
        <div id="candidate-intro-section" class="section hidden">
            <h3>Please Introduce Yourself</h3>
            <p>Tell us about your Excel experience, background, and skills:</p>
            <textarea id="candidate-intro" placeholder="Please introduce yourself and tell us about your Excel experience, projects you've worked on, and skills you consider your strengths..."></textarea>
            <button onclick="submitCandidateIntro()">Submit Introduction</button>
        </div>
        
        <div id="interview-section" class="section hidden">
            <h2>Interview</h2>
            <div id="question-container"></div>
            <textarea id="answer" placeholder="Type your answer..."></textarea>
            <button onclick="submitAnswer()">Submit Answer</button>
        </div>

         Result Section 
        <div id="result-section" class="section hidden">
            <h2>Interview Result</h2>
            <div id="result-output"></div>
            <button onclick="restart()">Restart</button>
        </div>
    </div>

    <script src="/static/script.js"></script>
</body>
</html> -->     
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Excel Mock Interviewer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .section {
            margin-bottom: 30px;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
        }

        .section.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .section h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
            position: relative;
        }

        .section h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #34495e;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .btn {
            display: inline-block;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            margin: 10px 5px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #34495e);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(149, 165, 166, 0.4);
        }

        .btn-media {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .btn-media:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .intro-container {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.1rem;
            line-height: 1.6;
            color: #2c3e50;
            text-align: left;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .question-container {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #2c3e50;
            text-align: left;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }

        .score-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-circle {
            display: inline-block;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            line-height: 100px;
            margin-bottom: 10px;
        }

        .result-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .result-section p {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        .step-line {
            width: 50px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .step-line.completed {
            background: #27ae60;
        }

        .video-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .video-box {
            position: relative;
            border: 3px solid #667eea;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        video {
            width: 300px;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .media-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .answer-recording-section {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .answer-recording-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .recording-status {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .recording-status p {
            margin: 0;
            color: #667eea;
            font-weight: 500;
        }

        .recording-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .recording-controls .btn {
            margin: 5px;
        }

        .recorder-textarea {
            width: 100%;
            min-height: 120px;
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            background: #f8f9fa;
        }

        .recorder-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .recorder-textarea[readonly] {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .recording-timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            margin: 10px 0;
        }

        .recording-indicator {
            display: none;
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }

        .recording-indicator.active {
            display: block;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
            border: 2px solid rgba(195, 230, 203, 0.5);
        }

        .status-error {
            background: rgba(248, 215, 218, 0.9);
            color: #721c24;
            border: 2px solid rgba(245, 198, 203, 0.5);
        }

        .media-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .step-indicator {
                flex-wrap: wrap;
            }

            video {
                width: 250px;
                height: 150px;
            }

            .video-container {
                flex-direction: column;
                align-items: center;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> AI Excel Interview</h1>
            <p class="subtitle">Professional Excel Skills Assessment</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator" id="step-indicator">
            <div class="step active" id="step-1">1</div>
            <div class="step-line" id="line-1"></div>
            <div class="step" id="step-2">2</div>
            <div class="step-line" id="line-2"></div>
            <div class="step" id="step-3">3</div>
            <div class="step-line" id="line-3"></div>
            <div class="step" id="step-4">4</div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- User Registration -->
        <div id="user-section" class="section animate-fade-in">
            <h2><i class="fas fa-user-plus"></i> Enter Details</h2>
            <div class="form-group">
                <label for="name">Full Name</label>
                <div class="input-wrapper">
                    <i class="fas fa-user"></i>
                    <input type="text" id="name" placeholder="Enter your full name" required>
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-wrapper">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" placeholder="Enter your email address" required>
                </div>
            </div>
            <div class="form-group">
                <label for="experience">Years of Excel Experience</label>
                <div class="input-wrapper">
                    <i class="fas fa-chart-bar"></i>
                    <select id="experience" required>
                        <option value="">Select your experience level</option>
                        <option value="0-1">0-1 years (Beginner)</option>
                        <option value="1-3">1-3 years (Intermediate)</option>
                        <option value="3-5">3-5 years (Advanced)</option>
                        <option value="5+">5+ years (Expert)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="position">Target Position</label>
                <div class="input-wrapper">
                    <i class="fas fa-briefcase"></i>
                    <input type="text" id="position" placeholder="e.g., Data Analyst, Financial Analyst" required>
                </div>
            </div>
            <div id="registration-status"></div>
            <button class="btn btn-primary" onclick="registerUser()">
                <i class="fas fa-arrow-right"></i> Start Assessment
            </button>
        </div>

        <!-- Media Activation Section -->
        <div id="media-activation-section" class="section hidden">
            <h2><i class="fas fa-video"></i> Media Setup</h2>
            <p style="color: #667eea; margin-bottom: 20px;">
                Please enable your camera to proceed with the interview. Screen sharing has been automatically enabled.
            </p>
            <div class="video-container">
                <div class="video-box">
                    <video id="cameraFeed" autoplay muted playsinline></video>
                    <div class="video-label">Camera</div>
                </div>
                <div class="video-box">
                    <video id="screenShare" autoplay muted playsinline></video>
                    <div class="video-label">Screen Share</div>
                </div>
            </div>
            <div class="media-controls">
                <button class="btn btn-media" id="camera-btn" onclick="startCamera()">
                    <i class="fas fa-video"></i> Start Camera
                </button>
                <button class="btn btn-media" id="screen-btn" disabled>
                    <i class="fas fa-desktop"></i> Screen Share Active
                </button>
                <button class="btn btn-primary" id="proceed-interview" disabled onclick="proceedToInterview()">
                    <i class="fas fa-arrow-right"></i> Proceed to Interview
                </button>
            </div>
            <div id="media-status"></div>
        </div>

        <!-- Candidate Introduction Section -->
        <div id="candidate-intro-section" class="section hidden">
            <h2><i class="fas fa-user-tie"></i> Introduction</h2>
            <div id="intro-container" class="intro-container">
                <i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>
                Welcome to your AI Excel interview! Please introduce yourself briefly. This will help me tailor the interview questions to your background and experience level.
            </div>
            <div class="form-group">
                <label for="candidate-intro">Tell us about yourself and your Excel experience</label>
                <textarea id="candidate-intro" placeholder="Introduce yourself, mention your Excel experience, key skills, projects you've worked on, and what makes you a good candidate for this position..." required></textarea>
            </div>
            <div id="intro-status"></div>
            <button class="btn btn-primary" onclick="submitCandidateIntro()">
                <i class="fas fa-arrow-right"></i> Continue to Interview
            </button>
        </div>

        <!-- Interview Section -->
        <div id="interview-section" class="section hidden">
            <h2><i class="fas fa-comments"></i> Interview Questions</h2>
            <div id="question-container" class="question-container">
                <i class="fas fa-question-circle" style="color: #667eea; margin-right: 10px;"></i>
                Loading your personalized question...
            </div>
            
            <!-- Answer Recording Section -->
            <div class="answer-recording-section">
                <h3><i class="fas fa-microphone"></i> Record Your Answer</h3>
                <div class="recording-status" id="recording-status">
                    <p><i class="fas fa-info-circle"></i> You can record your answer using voice or type directly.</p>
                </div>
                
                <textarea id="answer" class="recorder-textarea" placeholder="Type your answer here or use voice recording..." rows="6"></textarea>
                
                <div class="recording-indicator" id="recordingIndicator">
                    <i class="fas fa-circle"></i> Recording in progress...
                </div>
                
                <div class="recording-timer" id="recording-timer" style="display: none;">
                    Recording Time: <span id="timer-display">00:00</span>
                </div>
                
                <div class="recording-controls">
                    <button class="btn btn-media" id="start-record-btn" onclick="startRecording()">
                        <i class="fas fa-microphone"></i> Start Voice Recording
                    </button>
                    <button class="btn btn-media" id="stop-record-btn" onclick="stopRecording()" disabled>
                        <i class="fas fa-stop"></i> Stop Recording
                    </button>
                    <button class="btn btn-secondary" id="rerecord-btn" onclick="reRecordAnswer()" disabled>
                        <i class="fas fa-redo"></i> Re-record Voice
                    </button>
                    <button class="btn btn-primary" id="submit-btn" onclick="submitAnswer()">
                        <i class="fas fa-paper-plane"></i> Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="interview-status"></div>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="section hidden">
            <h2><i class="fas fa-trophy"></i> Interview Results</h2>
            <div class="result-card">
                <div id="result-output">
                    <div class="score-display">
                        <div class="score-circle">...</div>
                        <h3>Processing Results...</h3>
                    </div>
                </div>
            </div>
            <div id="result-status"></div>
            <button class="btn btn-primary" onclick="submitInterview()">
                <i class="fas fa-check"></i> Submit Interview
            </button>
            <button class="btn btn-secondary" onclick="restart()">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>

    <script>
        // Configuration - Update this to match your backend URL
        const BASE_URL = "http://127.0.0.1:8000";
        
        // Global variables
        let userId = null;
        let currentQuestionId = null;
        let currentStep = 1;
        let cameraStream = null;
        let screenStream = null;
        let recognition = null;
        let isRecording = false;
        let isCameraActive = false;
        let isScreenShareActive = false;
        let hasRecorded = false;
        let recordingTimer = null;
        let recordingStartTime = null;
        let userAnswers = [];
        let totalQuestions = 3;
        let candidateProfile = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[System] AI Excel Interview Initialized');
        });

        // Update progress and steps
        function updateProgress(step) {
            console.log(`[Progress] Updating to step ${step}`);
            currentStep = step;
            const progressPercent = (step - 1) * 25;
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                progressFill.style.width = `${progressPercent}%`;
            }

            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                const lineEl = document.getElementById(`line-${i}`);
                if (stepEl) {
                    if (i < step) {
                        stepEl.className = 'step completed';
                        if (lineEl) lineEl.className = 'step-line completed';
                    } else if (i === step) {
                        stepEl.className = 'step active';
                    } else {
                        stepEl.className = 'step';
                        if (lineEl) lineEl.className = 'step-line';
                    }
                }
            }
        }

        // Show loading state
        function showLoading(buttonElement) {
            if (!buttonElement) return "";
            const originalContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<span class="loading"></span>Processing...';
            buttonElement.disabled = true;
            return originalContent;
        }

        // Hide loading state
        function hideLoading(buttonElement, originalContent) {
            if (buttonElement) {
                buttonElement.innerHTML = originalContent;
                buttonElement.disabled = false;
            }
        }

        // Show status message
        function showStatus(elementId, message, isError = false) {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.innerHTML = `<div class="status-message ${isError ? 'status-error' : 'status-success'}">${message}</div>`;
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 5000);
            }
        }

        // Smooth section transitions
        function showSection(sectionId) {
            const allSections = document.querySelectorAll('.section');
            allSections.forEach(section => {
                section.classList.add('hidden');
            });

            setTimeout(() => {
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('animate-fade-in');
                }
            }, 200);
        }

        // Register User and Automatically Start Screen Sharing
        async function registerUser() {
            const button = event.target;
            const originalContent = showLoading(button);

            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            const experience = document.getElementById("experience").value;
            const position = document.getElementById("position").value.trim();

            if (!name || !email || !experience || !position) {
                showStatus('registration-status', 'Please fill in all fields', true);
                hideLoading(button, originalContent);
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('registration-status', 'Please enter a valid email address', true);
                hideLoading(button, originalContent);
                return;
            }

            const payload = { name, email, experience, position };

            try {
                const res = await fetch(`${BASE_URL}/users`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(15000)
                });

                const data = await res.json();

                if (res.ok) {
                    userId = data.id || `user-${Date.now()}`;
                    candidateProfile = { name, email, experience, position };
                    // Automatically start screen sharing
                    await startScreenShare();
                    updateProgress(2);
                    showSection('media-activation-section');
                    showStatus('media-status', 'Registration successful! Screen sharing has been enabled. Please enable your camera.');
                } else {
                    showStatus('registration-status', data.detail || 'Registration failed. Please try again.', true);
                }
            } catch (err) {
                console.error('[Registration] Error:', err);
                // Continue with offline mode
                userId = `demo-user-${Date.now()}`;
                candidateProfile = { name, email, experience, position };
                // Automatically start screen sharing
                await startScreenShare();
                updateProgress(2);
                showSection('media-activation-section');
                showStatus('media-status', 'Using offline mode. Screen sharing has been enabled. Please enable your camera.');
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Check if both camera and screen share are active
        function checkMediaStatus() {
            const proceedButton = document.getElementById('proceed-interview');
            const cameraBtn = document.getElementById('camera-btn');
            const screenBtn = document.getElementById('screen-btn');
            
            if (proceedButton) {
                proceedButton.disabled = !(isCameraActive && isScreenShareActive);
            }

            // Update button states
            if (isCameraActive && cameraBtn) {
                cameraBtn.innerHTML = '<i class="fas fa-check"></i> Camera Active';
                cameraBtn.disabled = true;
                cameraBtn.className = 'btn btn-success';
            }

            if (isScreenShareActive && screenBtn) {
                screenBtn.innerHTML = '<i class="fas fa-check"></i> Screen Share Active';
                screenBtn.disabled = true;
                screenBtn.className = 'btn btn-success';
            }

            if (isCameraActive && isScreenShareActive) {
                showStatus('media-status', 'Both camera and screen share are active! You can now proceed.', false);
            }
        }

        // Start camera
        async function startCamera() {
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 300 }, 
                        height: { ideal: 200 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                const cameraFeed = document.getElementById('cameraFeed');
                if (cameraFeed) {
                    cameraFeed.srcObject = cameraStream;
                    isCameraActive = true;
                    checkMediaStatus();
                    console.log('[Camera] Started successfully');
                }
            } catch (err) {
                console.error('[Camera] Error:', err);
                isCameraActive = false;
                showStatus('media-status', 'Camera access denied. Please allow camera access and try again.', true);
            }
        }

        // Start screen share (automatically share entire screen)
        async function startScreenShare() {
            try {
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                }
                
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        width: { ideal: 300 }, 
                        height: { ideal: 200 },
                        displaySurface: 'monitor', // Prefer entire screen
                        preferCurrentTab: false
                    },
                    audio: false
                });
                
                const screenShare = document.getElementById('screenShare');
                if (screenShare) {
                    screenShare.srcObject = screenStream;
                    isScreenShareActive = true;
                    checkMediaStatus();
                    console.log('[Screen Share] Entire screen sharing started successfully');
                    
                    // Handle screen share ending
                    screenStream.getVideoTracks().forEach(track => {
                        track.addEventListener('ended', () => {
                            console.log('[Screen Share] Track ended');
                            isScreenShareActive = false;
                            
                            const screenBtn = document.getElementById('screen-btn');
                            if (screenBtn) {
                                screenBtn.innerHTML = '<i class="fas fa-desktop"></i> Start Screen Share';
                                screenBtn.disabled = false;
                                screenBtn.className = 'btn btn-media';
                            }
                            showStatus('media-status', 'Screen sharing stopped. Please restart screen sharing to continue.', true);
                        });
                    });
                }
            } catch (err) {
                console.error('[Screen Share] Error:', err);
                isScreenShareActive = false;
                showStatus('media-status', 'Screen sharing denied. Please share your screen to continue.', true);
            }
        }

        // Proceed to Interview
        async function proceedToInterview() {
            if (!isCameraActive || !isScreenShareActive) {
                showStatus('media-status', 'Both camera and screen share must be active to proceed!', true);
                return;
            }

            const button = event.target;
            const originalContent = showLoading(button);

            try {
                await getInterviewerIntro(candidateProfile);
                updateProgress(3);
                showSection('candidate-intro-section');
            } catch (err) {
                updateProgress(3);
                showSection('candidate-intro-section');
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Fetch and display AI interviewer introduction using Gemini
        async function getInterviewerIntro(userProfile) {
            console.log("üîç Calling getInterviewerIntro with profile:", userProfile);
            try {
                const res = await fetch(`${BASE_URL}/interview/intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(userProfile),
                    signal: AbortSignal.timeout(15000)
                });
                console.log("üì° Response status:", res.status);
                const data = await res.json();
                console.log("üìÑ Response data:", data);
                
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    if (data.interviewer_introduction) {
                        console.log("‚úÖ Using interviewer_introduction");
                        introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>${data.interviewer_introduction}`;
                    } else if (data.intro) {
                        console.log("‚úÖ Using intro fallback");
                        introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>${data.intro}`;
                    } else {
                        console.log("‚ö†Ô∏è Using default message");
                        introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>Welcome to your AI Excel interview! I'm excited to assess your skills.`;
                    }
                }
            } catch (err) {
                console.error("‚ùå Error in getInterviewerIntro:", err);
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>Welcome to your AI Excel interview! I'm excited to assess your skills.`;
                }
            }
        }

        // Submit Candidate Introduction to Gemini for question generation
        async function submitCandidateIntro() {
            const button = event.target;
            const originalContent = showLoading(button);

            const candidateIntro = document.getElementById("candidate-intro").value.trim();
            if (!candidateIntro) {
                showStatus('intro-status', 'Please provide your introduction.', true);
                hideLoading(button, originalContent);
                return;
            }

            if (candidateIntro.length < 50) {
                showStatus('intro-status', 'Please provide a more detailed introduction (at least 50 characters).', true);
                hideLoading(button, originalContent);
                return;
            }

            try {
                // Send introduction to Gemini for analysis
                const res = await fetch(`${BASE_URL}/interview/analyze-intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ introduction: candidateIntro }),
                    signal: AbortSignal.timeout(20000)
                });
                
                if (res.ok) {
                    const profile = await res.json();
                    console.log("üìä Analyzed profile:", profile);
                    
                    window.candidateIntroduction = candidateIntro;
                    window.candidateProfile = profile;
                    
                    updateProgress(4);
                    showSection('interview-section');
                    await startInterview();
                } else {
                    throw new Error('Failed to analyze introduction');
                }
            } catch (err) {
                console.error('[Introduction] Error:', err);
                // Fallback with basic question
                window.candidateIntroduction = candidateIntro;
                window.candidateProfile = candidateProfile;
                updateProgress(4);
                showSection('interview-section');
                await startInterview();
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Start Interview with Gemini-generated question
        async function startInterview() {
            resetRecordingState();
            try {
                const res = await fetch(`${BASE_URL}/interview/${userId}/start`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ candidate_profile: window.candidateProfile }),
                    signal: AbortSignal.timeout(20000)
                });
                const data = await res.json();

                if (res.ok) {
                    currentQuestionId = data.question_id;
                    window.currentGeminiQuestion = data.first_question;
                    const questionContainer = document.getElementById("question-container");
                    if (questionContainer) {
                        questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #667eea; margin-right: 10px;"></i>${data.first_question}`;
                    }
                    console.log('[Interview] Started with Gemini-generated question');
                } else {
                    throw new Error(data.detail || 'Failed to start interview');
                }
            } catch (err) {
                console.error('[Interview Start] Error:', err);
                // Fallback with basic question
                currentQuestionId = 1;
                window.currentGeminiQuestion = "Based on your introduction, can you explain the difference between VLOOKUP and INDEX-MATCH functions in Excel, and when would you use each one in your work?";
                const questionContainer = document.getElementById("question-container");
                if (questionContainer) {
                    questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #667eea; margin-right: 10px;"></i>${window.currentGeminiQuestion}`;
                }
                console.log('[Interview] Started with fallback question');
            }
        }

        // Reset recording state for new question
        function resetRecordingState() {
            hasRecorded = false;
            isRecording = false;
            
            const answerField = document.getElementById('answer');
            const recordingIndicator = document.getElementById('recordingIndicator');
            const recordingTimer = document.getElementById('recording-timer');
            
            if (answerField) {
                answerField.value = '';
                answerField.readOnly = false;
            }
            
            if (recordingIndicator) recordingIndicator.classList.remove('active');
            if (recordingTimer) recordingTimer.style.display = 'none';
            
            enableAppropriateButtons();
            updateRecordingStatus('You can record your answer using voice or type directly.');
        }

        // Enable appropriate buttons based on current state
        function enableAppropriateButtons() {
            const startBtn = document.getElementById('start-record-btn');
            const stopBtn = document.getElementById('stop-record-btn');
            const rerecordBtn = document.getElementById('rerecord-btn');
            const submitBtn = document.getElementById('submit-btn');

            if (startBtn) startBtn.disabled = isRecording || hasRecorded;
            if (stopBtn) stopBtn.disabled = !isRecording;
            if (rerecordBtn) rerecordBtn.disabled = !hasRecorded || isRecording;
            if (submitBtn) submitBtn.disabled = false;
        }

        // Update recording status message
        function updateRecordingStatus(message, isError = false) {
            const statusElement = document.querySelector('.recording-status p');
            if (statusElement) {
                statusElement.innerHTML = `<i class="fas fa-${isError ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
                statusElement.style.color = isError ? '#dc3545' : '#667eea';
            }
        }

        // Speech Recognition
        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                updateRecordingStatus('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.', true);
                return;
            }

            if (isRecording) {
                updateRecordingStatus('Already recording', true);
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.continuous = true;

            let finalTranscript = '';
            recordingStartTime = Date.now();

            recognition.onstart = function() {
                isRecording = true;
                
                document.getElementById('recordingIndicator').classList.add('active');
                document.getElementById('recording-timer').style.display = 'block';
                
                startRecordingTimer();
                enableAppropriateButtons();
                
                updateRecordingStatus('üé§ Recording in progress - speak clearly into your microphone');
                console.log('[Voice Recording] Started');
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                finalTranscript = '';
                
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const answerField = document.getElementById('answer');
                if (answerField) {
                    answerField.value = finalTranscript + interimTranscript;
                }
            };

            recognition.onerror = function(event) {
                console.error('[Speech Recognition] Error:', event.error);
                updateRecordingStatus(`Recording error: ${event.error}. Please try again.`, true);
                stopRecording();
            };

            recognition.onend = function() {
                if (isRecording) {
                    stopRecording();
                }
            };

            try {
                recognition.start();
            } catch (err) {
                console.error('[Speech Recognition] Start error:', err);
                updateRecordingStatus('Failed to start recording: ' + err.message, true);
                isRecording = false;
                enableAppropriateButtons();
            }
        }

        // Start recording timer
        function startRecordingTimer() {
            const timerDisplay = document.getElementById('timer-display');
            recordingTimer = setInterval(() => {
                if (recordingStartTime && timerDisplay) {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Stop recording
        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            isRecording = false;
            
            document.getElementById('recordingIndicator').classList.remove('active');
            document.getElementById('recording-timer').style.display = 'none';
            
            const answerField = document.getElementById('answer');
            if (answerField && answerField.value.trim().length > 10) {
                hasRecorded = true;
                updateRecordingStatus('‚úÖ Recording completed successfully! You can now edit your answer, re-record, or submit it.');
                console.log('[Voice Recording] Completed successfully');
            } else {
                hasRecorded = false;
                updateRecordingStatus('‚ùå No sufficient speech detected. Please try recording again and speak clearly.', true);
                console.log('[Voice Recording] Failed - insufficient content');
            }
            
            enableAppropriateButtons();
        }

        // Re-record answer
        function reRecordAnswer() {
            const answerField = document.getElementById('answer');
            if (answerField) {
                answerField.value = '';
            }
            
            hasRecorded = false;
            enableAppropriateButtons();
            updateRecordingStatus('Ready to record again. Click "Start Voice Recording" to begin a new recording.');
            console.log('[Voice Recording] Reset for re-recording');
        }

        // Submit Answer to Gemini for evaluation and next question generation
        async function submitAnswer() {
            const button = event.target;
            const originalContent = showLoading(button);

            const answer = document.getElementById("answer").value.trim();
            
            if (!answer) {
                updateRecordingStatus('Please provide an answer before submitting', true);
                hideLoading(button, originalContent);
                return;
            }

            if (answer.length < 10) {
                updateRecordingStatus('Your answer seems too short. Please provide a more detailed response.', true);
                hideLoading(button, originalContent);
                return;
            }

            // Store the answer
            userAnswers.push({
                questionId: currentQuestionId,
                question: window.currentGeminiQuestion || "Excel question",
                answer: answer,
                timestamp: new Date().toISOString()
            });

            const payload = { question_id: currentQuestionId, user_answer: answer };

            try {
                const res = await fetch(`${BASE_URL}/interview/${userId}/answer`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(20000)
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById("answer").value = "";
                    if (data.finished) {
                        updateProgress(4);
                        await showGeminiResults();
                    } else {
                        currentQuestionId += 1;
                        window.currentGeminiQuestion = data.next_question;
                        const questionContainer = document.getElementById("question-container");
                        if (questionContainer) {
                            questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #667eea; margin-right: 10px;"></i>${data.next_question}`;
                        }
                        resetRecordingState();
                        updateRecordingStatus('Answer submitted successfully! Please provide your answer to the next question.');
                    }
                } else {
                    throw new Error(data.detail || 'Failed to submit answer');
                }
            } catch (err) {
                console.error('[Answer Submission] Error:', err);
                // Fallback logic
                if (currentQuestionId >= totalQuestions) {
                    await showGeminiResults();
                } else {
                    // Generate fallback next question
                    currentQuestionId++;
                    const fallbackQuestions = [
                        "How would you create a dynamic chart in Excel that updates automatically when new data is added?",
                        "Explain how you would use PivotTables to analyze sales data across different regions and time periods.",
                        "Describe the process of creating and using Excel macros to automate repetitive tasks."
                    ];
                    
                    const nextQuestion = fallbackQuestions[currentQuestionId - 2] || "Please describe your most challenging Excel project and how you solved it.";
                    window.currentGeminiQuestion = nextQuestion;
                    
                    const questionContainer = document.getElementById("question-container");
                    if (questionContainer) {
                        questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #667eea; margin-right: 10px;"></i>${nextQuestion}`;
                    }
                    resetRecordingState();
                    updateRecordingStatus('Answer submitted successfully! Please provide your answer to the next question.');
                }
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Show final results using Gemini evaluation
        async function showGeminiResults() {
            showSection('result-section');
            
            const resultOutput = document.getElementById('result-output');
            if (resultOutput) {
                resultOutput.innerHTML = `
                    <div class="score-display">
                        <div class="score-circle"><span class="loading"></span></div>
                        <h3>Evaluating your performance...</h3>
                    </div>
                `;
            }
            
            try {
                const res = await fetch(`${BASE_URL}/interview/${userId}/result`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    signal: AbortSignal.timeout(30000)
                });
                const data = await res.json();

                if (res.ok) {
                    displayGeminiResult(data);
                } else {
                    throw new Error(data.detail || 'Failed to fetch result');
                }
            } catch (err) {
                console.error('[Final Evaluation] Error:', err);
                // Fallback result
                const fallbackResult = {
                    overall_score: Math.floor(Math.random() * 30) + 70,
                    strengths: ["Good understanding of basic functions", "Clear communication"],
                    areas_of_progress: ["Advanced formulas", "Data analysis techniques"],
                    feedback_summary: "Your Excel knowledge shows promise. Continue practicing advanced functions and data analysis techniques."
                };
                displayGeminiResult(fallbackResult);
            }
        }

        // Display Gemini evaluation results
        function displayGeminiResult(result) {
            const resultOutput = document.getElementById('result-output');
            if (resultOutput) {
                const overallScore = result.overall_score || 75;
                
                let strengthsHTML = '';
                if (result.strengths && result.strengths.length > 0) {
                    strengthsHTML = `
                        <div class="result-section">
                            <h3>üí™ Your Strengths</h3>
                            <p>${result.strengths.join(', ')}</p>
                        </div>
                    `;
                }
                
                let improvementHTML = '';
                if (result.areas_of_progress && result.areas_of_progress.length > 0) {
                    improvementHTML = `
                        <div class="result-section">
                            <h3>üìà Areas for Improvement</h3>
                            <p>${result.areas_of_progress.join(', ')}</p>
                        </div>
                    `;
                }
                
                resultOutput.innerHTML = `
                    <div class="score-display">
                        <div class="score-circle">${Math.round(overallScore)}%</div>
                        <h3>Interview Completed</h3>
                    </div>
                    <div class="result-section">
                        <h3>üìä Performance Summary</h3>
                        <p><strong>Overall Score:</strong> ${Math.round(overallScore)}%</p>
                    </div>
                    <div class="result-section">
                        <h3>üìù Feedback</h3>
                        <p>${result.feedback_summary || 'Good performance overall. Continue developing your Excel skills.'}</p>
                    </div>
                    ${strengthsHTML}
                    ${improvementHTML}
                    <div class="result-section">
                        <h3>üéØ Recommendations</h3>
                        <p>${result.recommendations || 'Continue practicing Excel functions and consider advanced training courses.'}</p>
                    </div>
                `;
            }
            
            console.log('[Interview] Completed with Gemini AI evaluation');
        }

        // Submit Interview
        function submitInterview() {
            const button = event.target;
            const originalContent = showLoading(button);

            // Simulate submission (no backend API call, as per requirement)
            setTimeout(() => {
                showStatus('result-status', 'Interview submitted successfully', false);
                button.disabled = true; // Disable submit button after submission
                hideLoading(button, originalContent);
                console.log('[Interview] Submitted successfully');
            }, 1000);
        }

        // Restart interview with full reset
        function restart() {
            // Stop all media streams
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // Reset all variables
            userId = null;
            currentQuestionId = null;
            currentStep = 1;
            recognition = null;
            isRecording = false;
            isCameraActive = false;
            isScreenShareActive = false;
            hasRecorded = false;
            recordingTimer = null;
            recordingStartTime = null;
            userAnswers = [];
            candidateProfile = null;
            window.currentGeminiQuestion = null;
            window.candidateIntroduction = null;

            // Clear all form fields
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.value = '';
                input.disabled = false;
            });

            // Reset buttons
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.disabled = false;
                if (btn.id === 'camera-btn') {
                    btn.innerHTML = '<i class="fas fa-video"></i> Start Camera';
                    btn.className = 'btn btn-media';
                }
                if (btn.id === 'screen-btn') {
                    btn.innerHTML = '<i class="fas fa-desktop"></i> Start Screen Share';
                    btn.className = 'btn btn-media';
                }
            });

            // Reset progress and show first section
            updateProgress(1);
            showSection('user-section');
            
            console.log('[System] Interview reset completed - Ready for new interview');
        }

        console.log('[System] AI Excel Interview System Loaded Successfully');
    </script>
</body>
</html>