<!-- 


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Excel Mock Interviewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>AI-Powered Excel Mock Interviewer</h1>

        <!-- User Registration -->
 <!--  <div id="user-section" class="section">
            <h2>Register</h2>
            <input type="text" id="name" placeholder="Full Name">
            <input type="email" id="email" placeholder="Email">
            <input type="text" id="experience" placeholder="Experience (e.g. 2 years)">
            <input type="text" id="position" placeholder="Position (e.g. Data Analyst)">
            <button onclick="registerUser()">Register</button>
        </div>

         Interview Section 
        <div id="intro-container"></div>
        
         Candidate Introduction Section 
        <div id="candidate-intro-section" class="section hidden">
            <h3>Please Introduce Yourself</h3>
            <p>Tell us about your Excel experience, background, and skills:</p>
            <textarea id="candidate-intro" placeholder="Please introduce yourself and tell us about your Excel experience, projects you've worked on, and skills you consider your strengths..."></textarea>
            <button onclick="submitCandidateIntro()">Submit Introduction</button>
        </div>
        
        <div id="interview-section" class="section hidden">
            <h2>Interview</h2>
            <div id="question-container"></div>
            <textarea id="answer" placeholder="Type your answer..."></textarea>
            <button onclick="submitAnswer()">Submit Answer</button>
        </div>

         Result Section 
        <div id="result-section" class="section hidden">
            <h2>Interview Result</h2>
            <div id="result-output"></div>
            <button onclick="restart()">Restart</button>
        </div>
    </div>

    <script src="/static/script.js"></script>
</body>
</html> -->     
<!DOCTYPE html>
<html lang="en">
<head>
    
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI-Powered Excel Mock Interviewer</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
    
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: gradientShift 10s ease infinite;
            }
    
            @keyframes gradientShift {
                0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                50% { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
            }
    
            .container {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                max-width: 800px;
                width: 100%;
                padding: 40px;
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: all 0.3s ease;
                margin-bottom: 20px;
            }
    
            .container:hover {
                transform: translateY(-5px);
                box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
            }
    
            .header {
                margin-bottom: 30px;
            }
    
            .header h1 {
                color: #2c3e50;
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 10px;
                background: linear-gradient(45deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
    
            .header .subtitle {
                color: #7f8c8d;
                font-size: 1.1rem;
                font-weight: 400;
            }
    
            .section {
                margin-bottom: 30px;
                opacity: 1;
                transform: translateY(0);
                transition: all 0.5s ease;
            }
    
            .section.hidden {
                display: none;
                opacity: 0;
                transform: translateY(20px);
            }
    
            .section h2 {
                color: #2c3e50;
                font-size: 1.8rem;
                margin-bottom: 20px;
                position: relative;
            }
    
            .section h2::after {
                content: '';
                position: absolute;
                bottom: -10px;
                left: 50%;
                transform: translateX(-50%);
                width: 50px;
                height: 3px;
                background: linear-gradient(45deg, #667eea, #764ba2);
                border-radius: 2px;
            }
    
            .form-group {
                margin-bottom: 20px;
                text-align: left;
            }
    
            .form-group label {
                display: block;
                color: #34495e;
                font-weight: 600;
                margin-bottom: 8px;
                font-size: 0.95rem;
            }
    
            .input-wrapper {
                position: relative;
            }
    
            .input-wrapper i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #7f8c8d;
                font-size: 1.1rem;
            }
    
            input, textarea {
                width: 100%;
                padding: 15px 15px 15px 45px;
                border: 2px solid #e1e8ed;
                border-radius: 12px;
                font-size: 1rem;
                transition: all 0.3s ease;
                background: #f8f9fa;
                font-family: inherit;
            }
    
            input:focus, textarea:focus {
                outline: none;
                border-color: #667eea;
                background: #fff;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                transform: translateY(-2px);
            }
    
            textarea {
                min-height: 120px;
                resize: vertical;
                line-height: 1.6;
            }
    
            .btn {
                display: inline-block;
                padding: 15px 30px;
                font-size: 1rem;
                font-weight: 600;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                position: relative;
                overflow: hidden;
                margin: 10px 5px;
            }
    
            .btn-primary {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
    
            .btn-primary:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }
    
            .btn-secondary {
                background: linear-gradient(45deg, #95a5a6, #34495e);
                color: white;
                box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
            }
    
            .btn-secondary:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(149, 165, 166, 0.4);
            }
    
            .btn-media {
                background: linear-gradient(45deg, #e74c3c, #c0392b);
                color: white;
                box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
                padding: 10px 20px;
                font-size: 0.9rem;
            }
    
            .btn-media:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            }
    
            .btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s;
            }
    
            .btn:hover::before {
                left: 100%;
            }
    
            .progress-bar {
                width: 100%;
                height: 6px;
                background: #e1e8ed;
                border-radius: 3px;
                margin: 20px 0;
                overflow: hidden;
            }
    
            .progress-fill {
                height: 100%;
                background: linear-gradient(45deg, #667eea, #764ba2);
                border-radius: 3px;
                transition: width 0.5s ease;
                width: 0%;
            }
    
            .intro-container {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                padding: 25px;
                border-radius: 15px;
                margin: 20px 0;
                border-left: 5px solid #667eea;
                font-size: 1.1rem;
                line-height: 1.6;
                color: #2c3e50;
                text-align: left;
            }
    
            .question-container {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                padding: 25px;
                border-radius: 15px;
                margin: 20px 0;
                border-left: 5px solid #f39c12;
                font-size: 1.2rem;
                line-height: 1.6;
                color: #2c3e50;
                text-align: left;
                box-shadow: 0 5px 15px rgba(243, 156, 18, 0.2);
            }
    
            .result-card {
                background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
                padding: 30px;
                border-radius: 15px;
                margin: 20px 0;
                text-align: left;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }
    
            .score-display {
                text-align: center;
                margin-bottom: 20px;
            }
    
            .score-circle {
                display: inline-block;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                font-size: 2rem;
                font-weight: bold;
                line-height: 100px;
                margin-bottom: 10px;
            }
    
            .result-section h3 {
                color: #2c3e50;
                margin-bottom: 10px;
                font-size: 1.3rem;
            }
    
            .result-section p {
                color: #34495e;
                line-height: 1.6;
                margin-bottom: 15px;
            }
    
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 10px;
            }
    
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
    
            .step-indicator {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 30px;
            }
    
            .step {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #e1e8ed;
                color: #7f8c8d;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                margin: 0 10px;
                transition: all 0.3s ease;
            }
    
            .step.active {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                transform: scale(1.1);
            }
    
            .step.completed {
                background: #27ae60;
                color: white;
            }
    
            .step-line {
                width: 50px;
                height: 2px;
                background: #e1e8ed;
                transition: all 0.3s ease;
            }
    
            .step-line.completed {
                background: #27ae60;
            }
    
            /* Media Section Styles */
            .media-container {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                max-width: 800px;
                width: 100%;
                padding: 30px;
                margin-bottom: 20px;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
    
            .media-section {
                margin-bottom: 30px;
            }
    
            .media-section h3 {
                color: #2c3e50;
                font-size: 1.4rem;
                margin-bottom: 15px;
                text-align: center;
            }
    
            .video-container {
                display: flex;
                gap: 20px;
                justify-content: center;
                flex-wrap: wrap;
                margin-bottom: 20px;
            }
    
            .video-box {
                position: relative;
                border: 3px solid #667eea;
                border-radius: 15px;
                overflow: hidden;
                background: #000;
            }
    
            video {
                width: 300px;
                height: 200px;
                object-fit: cover;
                display: block;
            }
    
            .video-label {
                position: absolute;
                top: 10px;
                left: 10px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 0.8rem;
            }
    
            .media-controls {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }
    
            .answer-recorder {
                text-align: center;
            }
    
            .recorder-textarea {
                width: 100%;
                min-height: 120px;
                margin-bottom: 15px;
                padding: 15px;
                border: 2px solid #e1e8ed;
                border-radius: 12px;
                font-size: 1rem;
                font-family: inherit;
                resize: vertical;
            }
    
            .recording-indicator {
                display: none;
                color: #e74c3c;
                font-weight: bold;
                margin: 10px 0;
                animation: pulse 1.5s infinite;
            }
    
            .recording-indicator.active {
                display: block;
            }
    
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
    
            .status-message {
                padding: 10px;
                border-radius: 8px;
                margin: 10px 0;
                text-align: center;
                font-weight: 500;
            }
    
            .status-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
    
            .status-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
    
            @media (max-width: 768px) {
                .container, .media-container {
                    padding: 20px;
                    margin: 10px;
                }
    
                .header h1 {
                    font-size: 2rem;
                }
    
                .btn {
                    width: 100%;
                    margin: 5px 0;
                }
    
                .step-indicator {
                    flex-wrap: wrap;
                }
    
                video {
                    width: 250px;
                    height: 150px;
                }
    
                .video-container {
                    flex-direction: column;
                    align-items: center;
                }
            }
    
            .animate-fade-in {
                animation: fadeIn 0.5s ease-in;
            }
    
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        </style>
    
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> AI Excel Interview</h1>
            <p class="subtitle">Professional Excel Skills Assessment</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator" id="step-indicator">
            <div class="step active" id="step-1">1</div>
            <div class="step-line" id="line-1"></div>
            <div class="step" id="step-2">2</div>
            <div class="step-line" id="line-2"></div>
            <div class="step" id="step-3">3</div>
            <div class="step-line" id="line-3"></div>
            <div class="step" id="step-4">4</div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- User Registration -->
        <div id="user-section" class="section animate-fade-in">
            <h2><i class="fas fa-user-plus"></i> Registration</h2>
            <!-- Previous registration form fields remain unchanged -->
            <button class="btn btn-primary" onclick="registerUser()">
                <i class="fas fa-arrow-right"></i> Start Assessment
            </button>
        </div>

        <!-- Media Activation Section -->
        <div id="media-activation-section" class="section hidden">
            <h2><i class="fas fa-video"></i> Media Setup</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px;">
                Please enable both camera and screen sharing to proceed with the interview.
            </p>
            <div class="video-container">
                <div class="video-box">
                    <video id="cameraFeed" autoplay muted playsinline></video>
                    <div class="video-label">Camera</div>
                </div>
                <div class="video-box">
                    <video id="screenShare" autoplay muted playsinline></video>
                    <div class="video-label">Screen Share</div>
                </div>
            </div>
            <div class="media-controls">
                <button class="btn btn-media" onclick="startCamera()">
                    <i class="fas fa-video"></i> Start Camera
                </button>
                <button class="btn btn-media" onclick="startScreenShare()">
                    <i class="fas fa-desktop"></i> Start Screen Share
                </button>
                <button class="btn btn-primary" id="proceed-interview" disabled onclick="proceedToInterview()">
                    <i class="fas fa-arrow-right"></i> Proceed to Interview
                </button>
            </div>
            <div id="media-status"></div>
        </div>

        <!-- Previous sections (intro-container, candidate-intro-section, interview-section, result-section) remain unchanged -->

    </div>

    <!-- Answer Recorder Section -->
    <div class="media-container">
        <div class="media-section answer-recorder">
            <h3><i class="fas fa-microphone"></i> Answer Recorder</h3>
            <textarea id="answerBox" class="recorder-textarea" placeholder="Your answer will appear here... You can also type manually."></textarea>
            <div class="recording-indicator" id="recordingIndicator">
                <i class="fas fa-circle"></i> Recording in progress...
            </div>
            <div class="media-controls">
                <button class="btn btn-media" onclick="startRecording()">
                    <i class="fas fa-microphone"></i> Start Recording
                </button>
                <button class="btn btn-media" onclick="stopRecording()">
                    <i class="fas fa-stop"></i> Stop Recording
                </button>
                <button class="btn btn-media" onclick="clearAnswer()">
                    <i class="fas fa-edit"></i> Clear & Edit
                </button>
                <button class="btn btn-media" onclick="copyToMainAnswer()">
                    <i class="fas fa-copy"></i> Copy to Answer
                </button>
            </div>
            <div id="speech-status"></div>
        </div>
    </div>

    <script>
        const BASE_URL = "http://127.0.0.1:8000";
        let userId = null;
        let currentQuestionId = null;
        let currentStep = 1;
        let cameraStream = null;
        let screenStream = null;
        let recognition = null;
        let isRecording = false;
        let isCameraActive = false;
        let isScreenShareActive = false;
    
        // Update progress and steps
        function updateProgress(step) {
            console.log(`[Progress] Updating to step ${step}`);
            currentStep = step;
            const progressPercent = (step - 1) * 33.33;
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                progressFill.style.width = `${progressPercent}%`;
                console.log(`[Progress] Progress bar set to ${progressPercent}%`);
            } else {
                console.error("[Progress] Element 'progress-fill' not found");
            }
    
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                const lineEl = document.getElementById(`line-${i}`);
                if (!stepEl) {
                    console.error(`[Progress] Element 'step-${i}' not found`);
                    continue;
                }
                if (i < step) {
                    stepEl.className = 'step completed';
                    if (lineEl) lineEl.className = 'step-line completed';
                } else if (i === step) {
                    stepEl.className = 'step active';
                } else {
                    stepEl.className = 'step';
                    if (lineEl) lineEl.className = 'step-line';
                }
            }
        }
    
        // Show loading state
        function showLoading(buttonElement) {
            console.log("[UI] Showing loading state");
            if (!buttonElement) {
                console.error("[UI] Button element not provided");
                return "";
            }
            const originalContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<span class="loading"></span>Processing...';
            buttonElement.disabled = true;
            return originalContent;
        }
    
        // Hide loading state
        function hideLoading(buttonElement, originalContent) {
            console.log("[UI] Hiding loading state");
            if (buttonElement) {
                buttonElement.innerHTML = originalContent;
                buttonElement.disabled = false;
            } else {
                console.error("[UI] Button element not found for hiding loading");
            }
        }
    
        // Show status message
        function showStatus(elementId, message, isError = false) {
            console.log(`[Status] ${isError ? 'Error' : 'Success'}: ${message}`);
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.innerHTML = `<div class="status-message ${isError ? 'status-error' : 'status-success'}">${message}</div>`;
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 5000);
            } else {
                console.error(`[Status] Element '${elementId}' not found`);
                alert(message); // Fallback to alert
            }
        }
    
        // Smooth section transitions
        function showSection(sectionId) {
            console.log(`[UI] Attempting to show section: ${sectionId}`);
            const allSections = document.querySelectorAll('.section');
            if (!allSections.length) {
                console.error("[UI] No sections found in DOM");
                showStatus('media-status', 'Error: No sections found in page', true);
                return;
            }
    
            allSections.forEach(section => {
                section.classList.add('hidden');
            });
    
            setTimeout(() => {
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('animate-fade-in');
                    console.log(`[UI] Section '${sectionId}' displayed successfully`);
                } else {
                    console.error(`[UI] Section '${sectionId}' not found in DOM`);
                    showStatus('media-status', `Error: Section '${sectionId}' not found`, true);
                }
            }, 200);
        }
    
        // Register User
        async function registerUser() {
            console.log("[registerUser] Initiating registration process");
            const button = event.target;
            if (!button) {
                console.error("[registerUser] Button element not found");
                showStatus('media-status', 'Error: Button not found', true);
                return;
            }
            const originalContent = showLoading(button);
    
            // Check for each input individually
            const nameInput = document.getElementById("name");
            const emailInput = document.getElementById("email");
            const experienceInput = document.getElementById("experience");
            const positionInput = document.getElementById("position");
    
            const missingInputs = [];
            if (!nameInput) missingInputs.push("name");
            if (!emailInput) missingInputs.push("email");
            if (!experienceInput) missingInputs.push("experience");
            if (!positionInput) missingInputs.push("position");
    
            if (missingInputs.length > 0) {
                console.error("[registerUser] Missing form inputs:", missingInputs.join(", "));
                showStatus('media-status', `Error: Missing form fields (${missingInputs.join(", ")})`, true);
                hideLoading(button, originalContent);
                // Fallback for testing: proceed with default values
                console.log("[registerUser] Using fallback values for testing");
                userId = `test-user-${Date.now()}`;
                updateProgress(2);
                showSection('media-activation-section');
                showStatus('media-status', 'Proceeding with fallback due to missing inputs', true);
                hideLoading(button, originalContent);
                return;
            }
    
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const experience = experienceInput.value.trim();
            const position = positionInput.value.trim();
    
            console.log("[registerUser] Form values:", { name, email, experience, position });
    
            if (!name || !email || !experience || !position) {
                console.warn("[registerUser] Validation failed: Missing field values");
                showStatus('media-status', 'Please fill in all fields', true);
                hideLoading(button, originalContent);
                return;
            }
    
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                console.warn("[registerUser] Validation failed: Invalid email");
                showStatus('media-status', 'Please enter a valid email address', true);
                hideLoading(button, originalContent);
                return;
            }
    
            const payload = { name, email, experience, position };
            console.log("[registerUser] Payload prepared:", payload);
    
            // Temporary bypass for testing (uncomment to skip backend)
            /*
            console.log("[registerUser] Bypassing backend for testing");
            userId = `test-user-${Date.now()}`;
            updateProgress(2);
            showSection('media-activation-section');
            showStatus('media-status', 'Registration bypassed for testing', true);
            hideLoading(button, originalContent);
            return;
            */
    
            try {
                console.log("[API] Sending POST request to:", `${BASE_URL}/users`);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn("[API] Request timed out");
                }, 5000);
    
                const res = await fetch(`${BASE_URL}/users`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
    
                clearTimeout(timeoutId);
                console.log("[API] Response status:", res.status);
                const data = await res.json();
                console.log("[API] Response data:", data);
    
                if (res.status === 200 || res.status === 201) {
                    userId = data.id || `fallback-user-${Date.now()}`;
                    console.log("[registerUser] User registered, ID:", userId);
                    updateProgress(2);
                    showSection('media-activation-section');
                    showStatus('media-status', 'Registration successful! Please enable camera and screen share.');
                } else {
                    console.error("[registerUser] Server error:", res.status, data);
                    showStatus('media-status', data.detail || 'Error registering user. Proceeding with fallback.', true);
                    userId = `fallback-user-${Date.now()}`;
                    updateProgress(2);
                    showSection('media-activation-section');
                }
            } catch (err) {
                console.error("[registerUser] Fetch error:", err.message);
                showStatus('media-status', `Failed to connect to server: ${err.message}. Proceeding with fallback.`, true);
                userId = `fallback-user-${Date.now()}`;
                updateProgress(2);
                showSection('media-activation-section');
            } finally {
                hideLoading(button, originalContent);
                console.log("[registerUser] Registration process completed");
            }
        }
    
        // Check if both camera and screen share are active
        function checkMediaStatus() {
            console.log("[Media] Checking media status:", { isCameraActive, isScreenShareActive });
            const proceedButton = document.getElementById('proceed-interview');
            if (proceedButton) {
                proceedButton.disabled = !(isCameraActive && isScreenShareActive);
                console.log("[Media] Proceed button enabled:", !proceedButton.disabled);
            } else {
                console.error("[Media] Element 'proceed-interview' not found");
                showStatus('media-status', 'Error: Proceed button not found', true);
            }
        }
    
        // Start Camera
        async function startCamera() {
            console.log("[Media] Starting camera");
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 300, height: 200 },
                    audio: false
                });
                const cameraFeed = document.getElementById('cameraFeed');
                if (cameraFeed) {
                    cameraFeed.srcObject = cameraStream;
                    isCameraActive = true;
                    showStatus('media-status', 'Camera started successfully');
                    checkMediaStatus();
                } else {
                    console.error("[Media] Element 'cameraFeed' not found");
                    showStatus('media-status', 'Error: Camera feed element missing', true);
                }
            } catch (err) {
                console.error("[Media] Camera error:", err.message);
                showStatus('media-status', `Camera error: ${err.message}`, true);
            }
        }
    
        // Start Screen Share
        async function startScreenShare() {
            console.log("[Media] Starting screen share");
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: 300, height: 200 }
                });
                const screenShare = document.getElementById('screenShare');
                if (screenShare) {
                    screenShare.srcObject = screenStream;
                    isScreenShareActive = true;
                    showStatus('media-status', 'Screen sharing started');
                    screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                        console.warn("[Media] Screen share stopped by user, restarting...");
                        showStatus('media-status', 'Screen sharing is mandatory. Restarting...', true);
                        startScreenShare();
                    });
                    checkMediaStatus();
                } else {
                    console.error("[Media] Element 'screenShare' not found");
                    showStatus('media-status', 'Error: Screen share element missing', true);
                }
            } catch (err) {
                console.error("[Media] Screen share error:", err.message);
                showStatus('media-status', `Screen share error: ${err.message}`, true);
            }
        }
    
        // Prevent stopping media
        function stopCamera() {
            console.warn("[Media] Attempted to stop camera");
            showStatus('media-status', 'Camera cannot be stopped during the interview', true);
        }
    
        function stopScreenShare() {
            console.warn("[Media] Attempted to stop screen share");
            showStatus('media-status', 'Screen sharing cannot be stopped during the interview', true);
        }
    
        // Proceed to Interview
        async function proceedToInterview() {
            console.log("[Navigation] Proceeding to interview");
            if (!isCameraActive || !isScreenShareActive) {
                console.warn("[Navigation] Media not active");
                showStatus('media-status', 'Both camera and screen share must be active', true);
                return;
            }
    
            const button = event.target;
            const originalContent = showLoading(button);
    
            try {
                await getInterviewerIntro({
                    name: document.getElementById("name")?.value.trim() || "Unknown",
                    email: document.getElementById("email")?.value.trim() || "unknown@example.com",
                    experience: document.getElementById("experience")?.value.trim() || "Unknown",
                    position: document.getElementById("position")?.value.trim() || "Unknown"
                });
                updateProgress(3);
                showSection('candidate-intro-section');
                showStatus('media-status', 'Proceeding to candidate introduction');
            } catch (err) {
                console.error("[Navigation] Error proceeding to interview:", err.message);
                showStatus('media-status', 'Failed to proceed to interview. Using fallback.', true);
                updateProgress(3);
                showSection('candidate-intro-section');
            } finally {
                hideLoading(button, originalContent);
            }
        }
    
        // Fetch and display AI interviewer introduction
        async function getInterviewerIntro(userProfile) {
            console.log("[API] Fetching interviewer intro with profile:", userProfile);
            try {
                const res = await fetch(`${BASE_URL}/interview/intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(userProfile),
                    signal: AbortSignal.timeout(5000)
                });
                console.log("[API] Intro response status:", res.status);
                const data = await res.json();
                console.log("[API] Intro response data:", data);
    
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    if (data.interviewer_introduction) {
                        introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>${data.interviewer_introduction}`;
                    } else if (data.intro) {
                        introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>${data.intro}`;
                    } else {
                        introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>Welcome to your AI Excel interview! I'm excited to assess your skills.`;
                    }
                    introContainer.classList.remove('hidden');
                    console.log("[UI] Intro container updated");
                } else {
                    console.error("[UI] Element 'intro-container' not found");
                    showStatus('media-status', 'Error: Intro container missing', true);
                }
            } catch (err) {
                console.error("[API] Error in getInterviewerIntro:", err.message);
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>Welcome to your AI Excel interview! I'm excited to assess your skills.`;
                    introContainer.classList.remove('hidden');
                }
                showStatus('media-status', 'Failed to fetch interviewer intro. Using default message.', true);
            }
        }
    
        // Submit Candidate Introduction
        async function submitCandidateIntro() {
            console.log("[submitCandidateIntro] Submitting candidate introduction");
            const button = event.target;
            const originalContent = showLoading(button);
    
            const candidateIntroInput = document.getElementById("candidate-intro");
            if (!candidateIntroInput) {
                console.error("[submitCandidateIntro] Element 'candidate-intro' not found");
                showStatus('media-status', 'Error: Introduction field missing', true);
                hideLoading(button, originalContent);
                return;
            }
    
            const candidateIntro = candidateIntroInput.value.trim();
            if (!candidateIntro) {
                console.warn("[submitCandidateIntro] Validation failed: Empty introduction");
                showStatus('media-status', 'Please provide your introduction.', true);
                hideLoading(button, originalContent);
                return;
            }
    
            try {
                console.log("[API] Sending POST to:", `${BASE_URL}/interview/analyze-intro`);
                const res = await fetch(`${BASE_URL}/interview/analyze-intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ introduction: candidateIntro }),
                    signal: AbortSignal.timeout(5000)
                });
                console.log("[API] Analyze intro response status:", res.status);
                const profile = await res.json();
                console.log("[API] Analyzed profile:", profile);
    
                window.candidateIntroduction = candidateIntro;
                window.candidateProfile = profile;
    
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    introContainer.style.display = "none";
                    console.log("[UI] Intro container hidden");
                } else {
                    console.error("[UI] Element 'intro-container' not found");
                    showStatus('media-status', 'Error: Intro container missing', true);
                }
    
                updateProgress(4);
                showSection('interview-section');
                await startInterview();
            } catch (err) {
                console.error("[API] Error analyzing introduction:", err.message);
                showStatus('media-status', 'Failed to analyze introduction. Proceeding to interview.', true);
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    introContainer.style.display = "none";
                }
                updateProgress(4);
                showSection('interview-section');
                await startInterview();
            } finally {
                hideLoading(button, originalContent);
                console.log("[submitCandidateIntro] Submission process completed");
            }
        }
    
        // Start Interview
        async function startInterview() {
            console.log("[startInterview] Starting interview for user:", userId);
            try {
                const candidateProfile = window.candidateProfile || null;
                console.log("[API] Sending POST to:", `${BASE_URL}/interview/${userId}/start`);
                const res = await fetch(`${BASE_URL}/interview/${userId}/start`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ candidate_profile: candidateProfile }),
                    signal: AbortSignal.timeout(5000)
                });
                console.log("[API] Start interview response status:", res.status);
                const data = await res.json();
                console.log("[API] Start interview response:", data);
    
                if (res.status === 200) {
                    currentQuestionId = data.question_id;
                    const questionContainer = document.getElementById("question-container");
                    if (questionContainer) {
                        questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>${data.first_question}`;
                        console.log("[UI] Question container updated");
                    } else {
                        console.error("[UI] Element 'question-container' not found");
                        showStatus('media-status', 'Error: Question container missing', true);
                    }
                } else {
                    console.error("[startInterview] Error:", data);
                    showStatus('media-status', data.detail || 'Error starting interview.', true);
                }
            } catch (err) {
                console.error("[startInterview] Fetch error:", err.message);
                showStatus('media-status', 'Failed to start interview.', true);
            }
        }
    
        // Submit Answer
        async function submitAnswer() {
            console.log("[submitAnswer] Submitting answer for question:", currentQuestionId);
            const button = event.target;
            const originalContent = showLoading(button);
    
            const answerInput = document.getElementById("answer");
            if (!answerInput) {
                console.error("[submitAnswer] Element 'answer' not found");
                showStatus('media-status', 'Error: Answer field missing', true);
                hideLoading(button, originalContent);
                return;
            }
    
            const answer = answerInput.value.trim();
            if (!answer) {
                console.warn("[submitAnswer] Validation failed: Empty answer");
                showStatus('media-status', 'Please enter your answer.', true);
                hideLoading(button, originalContent);
                return;
            }
    
            const payload = { question_id: currentQuestionId, user_answer: answer };
            try {
                console.log("[API] Sending POST to:", `${BASE_URL}/interview/${userId}/answer`);
                const res = await fetch(`${BASE_URL}/interview/${userId}/answer`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(5000)
                });
                console.log("[API] Submit answer response status:", res.status);
                const data = await res.json();
                console.log("[API] Submit answer response:", data);
    
                if (res.status === 200) {
                    answerInput.value = "";
                    if (data.finished) {
                        updateProgress(5);
                        await showResult();
                    } else {
                        currentQuestionId += 1;
                        const questionContainer = document.getElementById("question-container");
                        if (questionContainer) {
                            questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>${data.next_question}`;
                        } else {
                            console.error("[UI] Element 'question-container' not found");
                        }
                    }
                } else {
                    console.error("[submitAnswer] Error:", data);
                    showStatus('media-status', data.detail || 'Error submitting answer.', true);
                }
            } catch (err) {
                console.error("[submitAnswer] Fetch error:", err.message);
                showStatus('media-status', 'Failed to submit answer.', true);
            } finally {
                hideLoading(button, originalContent);
            }
        }
    
        // Show Final Result
        async function showResult() {
            console.log("[showResult] Fetching interview results");
            showSection('result-section');
    
            try {
                console.log("[API] Sending GET to:", `${BASE_URL}/interview/${userId}/result`);
                const res = await fetch(`${BASE_URL}/interview/${userId}/result`, {
                    signal: AbortSignal.timeout(5000)
                });
                console.log("[API] Result response status:", res.status);
                const data = await res.json();
                console.log("[API] Result response:", data);
    
                if (res.status === 200) {
                    const resultOutput = document.getElementById("result-output");
                    if (resultOutput) {
                        resultOutput.innerHTML = `
                            <div class="score-display">
                                <div class="score-circle">${data.overall_score || 'N/A'}</div>
                                <h3>Overall Score</h3>
                            </div>
                            <div class="result-section">
                                <h3><i class="fas fa-star" style="color: #f39c12;"></i> Strengths</h3>
                                <p>${data.strengths?.join(", ") || 'None provided'}</p>
                            </div>
                            <div class="result-section">
                                <h3><i class="fas fa-chart-line" style="color: #3498db;"></i> Areas for Growth</h3>
                                <p>${data.areas_of_progress?.join(", ") || 'None provided'}</p>
                            </div>
                            <div class="result-section">
                                <h3><i class="fas fa-comments" style="color: #27ae60;"></i> Detailed Feedback</h3>
                                <p>${data.feedback_summary || 'No feedback available'}</p>
                            </div>
                        `;
                        console.log("[UI] Result output updated");
                    } else {
                        console.error("[UI] Element 'result-output' not found");
                        showStatus('media-status', 'Error: Result output element missing', true);
                    }
                } else {
                    console.error("[showResult] Error:", data);
                    showStatus('media-status', data.detail || 'Error fetching result.', true);
                }
            } catch (err) {
                console.error("[showResult] Fetch error:", err.message);
                showStatus('media-status', 'Failed to fetch result.', true);
            }
        }
    
        // Restart
        function restart() {
            console.log("[Navigation] Restarting interview");
            location.reload();
        }
    
        // Speech Recognition Functions
        function startRecording() {
            console.log("[Speech] Starting recording");
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("[Speech] Speech recognition not supported");
                showStatus('speech-status', 'Speech recognition is not supported in your browser', true);
                return;
            }
    
            if (isRecording) {
                console.warn("[Speech] Already recording");
                showStatus('speech-status', 'Already recording', true);
                return;
            }
    
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.continuous = true;
    
            let finalTranscript = '';
            let interimTranscript = '';
    
            recognition.onstart = function() {
                console.log("[Speech] Recording started");
                isRecording = true;
                const recordingIndicator = document.getElementById('recordingIndicator');
                if (recordingIndicator) {
                    recordingIndicator.classList.add('active');
                }
                showStatus('speech-status', 'Recording started - speak now');
            };
    
            recognition.onresult = function(event) {
                interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                const answerBox = document.getElementById('answerBox');
                const mainAnswerField = document.getElementById('answer');
                if (answerBox && mainAnswerField) {
                    answerBox.value = finalTranscript + interimTranscript;
                    mainAnswerField.value = finalTranscript + interimTranscript;
                    console.log("[Speech] Transcription updated:", finalTranscript + interimTranscript);
                } else {
                    console.error("[Speech] Answer box or main answer field not found");
                    showStatus('speech-status', 'Error: Answer fields missing', true);
                }
            };
    
            recognition.onerror = function(event) {
                console.error("[Speech] Recognition error:", event.error);
                showStatus('speech-status', 'Recognition error: ' + event.error, true);
                stopRecording();
            };
    
            recognition.onend = function() {
                console.log("[Speech] Recording ended");
                isRecording = false;
                const recordingIndicator = document.getElementById('recordingIndicator');
                if (recordingIndicator) {
                    recordingIndicator.classList.remove('active');
                }
                if (finalTranscript) {
                    showStatus('speech-status', 'Recording completed successfully');
                }
            };
    
            try {
                recognition.start();
                console.log("[Speech] Recognition started");
            } catch (err) {
                console.error("[Speech] Failed to start recognition:", err.message);
                showStatus('speech-status', 'Failed to start recording', true);
                isRecording = false;
            }
        }
    
        function stopRecording() {
            console.log("[Speech] Stopping recording");
            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false;
                const recordingIndicator = document.getElementById('recordingIndicator');
                if (recordingIndicator) {
                    recordingIndicator.classList.remove('active');
                }
                showStatus('speech-status', 'Recording stopped. You can now edit the answer.');
            }
        }
    
        function clearAnswer() {
            console.log("[Speech] Clearing answer");
            const answerBox = document.getElementById('answerBox');
            const mainAnswerField = document.getElementById('answer');
            if (answerBox && mainAnswerField) {
                answerBox.value = '';
                mainAnswerField.value = '';
                showStatus('speech-status', 'Answer cleared - ready for editing');
            } else {
                console.error("[Speech] Answer box or main answer field not found");
                showStatus('speech-status', 'Error: Answer fields missing', true);
            }
        }
    
        function copyToMainAnswer() {
            console.log("[Speech] Copying to main answer");
            const recordedAnswer = document.getElementById('answerBox')?.value;
            const mainAnswerField = document.getElementById('answer');
            if (recordedAnswer && mainAnswerField) {
                mainAnswerField.value = recordedAnswer;
                showStatus('speech-status', 'Answer copied to main answer field');
            } else {
                console.error("[Speech] No text to copy or main answer field not found");
                showStatus('speech-status', 'No text to copy', true);
            }
        }
    
        // Cleanup when page unloads
        window.addEventListener('beforeunload', function() {
            console.log("[Cleanup] Cleaning up media streams");
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            stopRecording();
        });
    
        // Prevent browser back button
        window.addEventListener('popstate', function(event) {
            console.log("[Navigation] Back button detected, current step:", currentStep);
            if (currentStep > 2) {
                history.pushState(null, null, window.location.href);
                showStatus('media-status', 'Cannot go back during active interview', true);
            }
        });
    
        // Initialize history state
        history.pushState(null, null, window.location.href);
        console.log("[Init] Page loaded, history state initialized");
    
        // Initial DOM check
        window.addEventListener('load', function() {
            console.log("[Init] Checking DOM elements");
            const elements = [
                'user-section',
                'media-activation-section',
                'candidate-intro-section',
                'interview-section',
                'result-section',
                'intro-container',
                'name',
                'email',
                'experience',
                'position'
            ];
            elements.forEach(id => {
                if (!document.getElementById(id)) {
                    console.error(`[Init] Element '${id}' not found`);
                    showStatus('media-status', `Error: Element '${id}' missing`, true);
                }
            });
        });
    </script>