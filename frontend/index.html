<!-- 


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Excel Mock Interviewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>AI-Powered Excel Mock Interviewer</h1>

        <!-- User Registration -->
 <!--  <div id="user-section" class="section">
            <h2>Register</h2>
            <input type="text" id="name" placeholder="Full Name">
            <input type="email" id="email" placeholder="Email">
            <input type="text" id="experience" placeholder="Experience (e.g. 2 years)">
            <input type="text" id="position" placeholder="Position (e.g. Data Analyst)">
            <button onclick="registerUser()">Register</button>
        </div>

         Interview Section 
        <div id="intro-container"></div>
        
         Candidate Introduction Section 
        <div id="candidate-intro-section" class="section hidden">
            <h3>Please Introduce Yourself</h3>
            <p>Tell us about your Excel experience, background, and skills:</p>
            <textarea id="candidate-intro" placeholder="Please introduce yourself and tell us about your Excel experience, projects you've worked on, and skills you consider your strengths..."></textarea>
            <button onclick="submitCandidateIntro()">Submit Introduction</button>
        </div>
        
        <div id="interview-section" class="section hidden">
            <h2>Interview</h2>
            <div id="question-container"></div>
            <textarea id="answer" placeholder="Type your answer..."></textarea>
            <button onclick="submitAnswer()">Submit Answer</button>
        </div>

         Result Section 
        <div id="result-section" class="section hidden">
            <h2>Interview Result</h2>
            <div id="result-output"></div>
            <button onclick="restart()">Restart</button>
        </div>
    </div>

    <script src="/static/script.js"></script>
</body>
</html> -->     
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Excel Mock Interviewer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: gradientShift 10s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
            50% { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .section {
            margin-bottom: 30px;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
        }

        .section.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .section h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
            position: relative;
        }

        .section h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #34495e;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .btn {
            display: inline-block;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            margin: 10px 5px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #34495e);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(149, 165, 166, 0.4);
        }

        .btn-media {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .btn-media:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .intro-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
            font-size: 1.1rem;
            line-height: 1.6;
            color: #2c3e50;
            text-align: left;
        }

        .question-container {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #f39c12;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #2c3e50;
            text-align: left;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.2);
        }

        .result-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .score-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-circle {
            display: inline-block;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            line-height: 100px;
            margin-bottom: 10px;
        }

        .result-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .result-section p {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e1e8ed;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        .step-line {
            width: 50px;
            height: 2px;
            background: #e1e8ed;
            transition: all 0.3s ease;
        }

        .step-line.completed {
            background: #27ae60;
        }

        .video-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .video-box {
            position: relative;
            border: 3px solid #667eea;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        video {
            width: 300px;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .media-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .answer-recorder {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .answer-recorder h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .recorder-textarea {
            width: 100%;
            min-height: 120px;
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .recording-indicator {
            display: none;
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }

        .recording-indicator.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .media-warning {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }

        .media-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container, .answer-recorder {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .step-indicator {
                flex-wrap: wrap;
            }

            video {
                width: 250px;
                height: 150px;
            }

            .video-container {
                flex-direction: column;
                align-items: center;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> AI Excel Interview</h1>
            <p class="subtitle">Professional Excel Skills Assessment</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator" id="step-indicator">
            <div class="step active" id="step-1">1</div>
            <div class="step-line" id="line-1"></div>
            <div class="step" id="step-2">2</div>
            <div class="step-line" id="line-2"></div>
            <div class="step" id="step-3">3</div>
            <div class="step-line" id="line-3"></div>
            <div class="step" id="step-4">4</div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- User Registration -->
        <div id="user-section" class="section animate-fade-in">
            <h2><i class="fas fa-user-plus"></i> Registration</h2>
            <div class="form-group">
                <label for="name">Full Name</label>
                <div class="input-wrapper">
                    <i class="fas fa-user"></i>
                    <input type="text" id="name" placeholder="Enter your full name" required>
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-wrapper">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" placeholder="Enter your email address" required>
                </div>
            </div>
            <div class="form-group">
                <label for="experience">Years of Excel Experience</label>
                <div class="input-wrapper">
                    <i class="fas fa-chart-bar"></i>
                    <select id="experience" required>
                        <option value="">Select your experience level</option>
                        <option value="0-1">0-1 years (Beginner)</option>
                        <option value="1-3">1-3 years (Intermediate)</option>
                        <option value="3-5">3-5 years (Advanced)</option>
                        <option value="5+">5+ years (Expert)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="position">Target Position</label>
                <div class="input-wrapper">
                    <i class="fas fa-briefcase"></i>
                    <input type="text" id="position" placeholder="e.g., Data Analyst, Financial Analyst" required>
                </div>
            </div>
            <div id="registration-status"></div>
            <button class="btn btn-primary" onclick="registerUser()">
                <i class="fas fa-arrow-right"></i> Start Assessment
            </button>
        </div>

        <!-- Media Activation Section -->
        <div id="media-activation-section" class="section hidden">
            <h2><i class="fas fa-video"></i> Media Setup</h2>
            <div class="media-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Both camera and screen sharing are mandatory for this interview. 
                You cannot proceed without enabling both.
            </div>
            <p style="color: #7f8c8d; margin-bottom: 20px;">
                Please enable both camera and screen sharing to proceed with the interview.
            </p>
            <div class="video-container">
                <div class="video-box">
                    <video id="cameraFeed" autoplay muted playsinline></video>
                    <div class="video-label">Camera</div>
                </div>
                <div class="video-box">
                    <video id="screenShare" autoplay muted playsinline></video>
                    <div class="video-label">Screen Share</div>
                </div>
            </div>
            <div class="media-controls">
                <button class="btn btn-media" id="camera-btn" onclick="startCamera()">
                    <i class="fas fa-video"></i> Start Camera
                </button>
                <button class="btn btn-media" id="screen-btn" onclick="startScreenShare()">
                    <i class="fas fa-desktop"></i> Start Screen Share
                </button>
                <button class="btn btn-primary" id="proceed-interview" disabled onclick="proceedToInterview()">
                    <i class="fas fa-arrow-right"></i> Proceed to Interview
                </button>
            </div>
            <div id="media-status"></div>
        </div>

        <!-- Candidate Introduction Section -->
        <div id="candidate-intro-section" class="section hidden">
            <h2><i class="fas fa-user-tie"></i> Introduction</h2>
            <div id="intro-container" class="intro-container">
                <i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>
                Welcome to your AI Excel interview! Please introduce yourself briefly.
            </div>
            <div class="form-group">
                <label for="candidate-intro">Tell us about yourself and your Excel experience</label>
                <textarea id="candidate-intro" placeholder="Introduce yourself, mention your Excel experience, key skills, and what makes you a good candidate for this position..." required></textarea>
            </div>
            <div id="intro-status"></div>
            <button class="btn btn-primary" onclick="submitCandidateIntro()">
                <i class="fas fa-arrow-right"></i> Continue to Interview
            </button>
        </div>

        <!-- Interview Section -->
        <div id="interview-section" class="section hidden">
            <h2><i class="fas fa-comments"></i> Interview Questions</h2>
            <div id="question-container" class="question-container">
                <i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>
                Loading your first question...
            </div>
            <div class="form-group">
                <label for="answer">Your Answer</label>
                <textarea id="answer" placeholder="Type your answer here or use the recorder below..." rows="6" required></textarea>
            </div>
            <div id="interview-status"></div>
            <button class="btn btn-primary" onclick="submitAnswer()">
                <i class="fas fa-paper-plane"></i> Submit Answer
            </button>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="section hidden">
            <h2><i class="fas fa-trophy"></i> Interview Results</h2>
            <div class="result-card">
                <div id="result-output">
                    <div class="score-display">
                        <div class="score-circle">...</div>
                        <h3>Processing Results...</h3>
                    </div>
                </div>
            </div>
            <div id="result-status"></div>
            <button class="btn btn-secondary" onclick="restart()">
                <i class="fas fa-redo"></i> Start New Interview
            </button>
        </div>
    </div>

    <!-- Answer Recorder Section -->
    <div class="answer-recorder" id="answer-recorder" style="display: none;">
        <h3><i class="fas fa-microphone"></i> Answer Recorder</h3>
        <textarea id="answerBox" class="recorder-textarea" placeholder="Your recorded answer will appear here... You can also type manually."></textarea>
        <div class="recording-indicator" id="recordingIndicator">
            <i class="fas fa-circle"></i> Recording in progress...
        </div>
        <div class="media-controls">
            <button class="btn btn-media" id="start-record-btn" onclick="startRecording()">
                <i class="fas fa-microphone"></i> Start Recording
            </button>
            <button class="btn btn-media" id="stop-record-btn" onclick="stopRecording()" disabled>
                <i class="fas fa-stop"></i> Stop Recording
            </button>
            <button class="btn btn-success" onclick="copyToMainAnswer()">
                <i class="fas fa-copy"></i> Copy to Answer
            </button>
            <button class="btn btn-secondary" onclick="clearAnswer()">
                <i class="fas fa-edit"></i> Clear & Edit
            </button>
        </div>
        <div id="speech-status"></div>
    </div>

    <script>
        const BASE_URL = "http://127.0.0.1:8000";
        let userId = null;
        let currentQuestionId = null;
        let currentStep = 1;
        let cameraStream = null;
        let screenStream = null;
        let recognition = null;
        let isRecording = false;
        let isCameraActive = false;
        let isScreenShareActive = false;

        // Update progress and steps
        function updateProgress(step) {
            console.log(`[Progress] Updating to step ${step}`);
            currentStep = step;
            const progressPercent = (step - 1) * 25;
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                progressFill.style.width = `${progressPercent}%`;
            }

            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                const lineEl = document.getElementById(`line-${i}`);
                if (stepEl) {
                    if (i < step) {
                        stepEl.className = 'step completed';
                        if (lineEl) lineEl.className = 'step-line completed';
                    } else if (i === step) {
                        stepEl.className = 'step active';
                    } else {
                        stepEl.className = 'step';
                        if (lineEl) lineEl.className = 'step-line';
                    }
                }
            }
        }

        // Show loading state
        function showLoading(buttonElement) {
            if (!buttonElement) return "";
            const originalContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<span class="loading"></span>Processing...';
            buttonElement.disabled = true;
            return originalContent;
        }

        // Hide loading state
        function hideLoading(buttonElement, originalContent) {
            if (buttonElement) {
                buttonElement.innerHTML = originalContent;
                buttonElement.disabled = false;
            }
        }

        // Show status message
        function showStatus(elementId, message, isError = false) {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.innerHTML = `<div class="status-message ${isError ? 'status-error' : 'status-success'}">${message}</div>`;
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 5000);
            }
        }

        // Smooth section transitions
        function showSection(sectionId) {
            const allSections = document.querySelectorAll('.section');
            allSections.forEach(section => {
                section.classList.add('hidden');
            });

            setTimeout(() => {
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('animate-fade-in');
                    
                    // Show answer recorder for interview section
                    const answerRecorder = document.getElementById('answer-recorder');
                    if (sectionId === 'interview-section' && answerRecorder) {
                        answerRecorder.style.display = 'block';
                    } else if (answerRecorder) {
                        answerRecorder.style.display = 'none';
                    }
                }
            }, 200);
        }

        // Register User
        async function registerUser() {
            const button = event.target;
            const originalContent = showLoading(button);

            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            const experience = document.getElementById("experience").value;
            const position = document.getElementById("position").value.trim();

            if (!name || !email || !experience || !position) {
                showStatus('registration-status', 'Please fill in all fields', true);
                hideLoading(button, originalContent);
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('registration-status', 'Please enter a valid email address', true);
                hideLoading(button, originalContent);
                return;
            }

            const payload = { name, email, experience, position };

            try {
                const res = await fetch(`${BASE_URL}/users`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(10000)
                });

                const data = await res.json();

                if (res.ok) {
                    userId = data.id || `user-${Date.now()}`;
                    updateProgress(2);
                    showSection('media-activation-section');
                    showStatus('media-status', 'Registration successful! Please enable camera and screen share.');
                } else {
                    showStatus('registration-status', data.detail || 'Registration failed. Please try again.', true);
                }
            } catch (err) {
                // For demo purposes, continue with fallback
                userId = `demo-user-${Date.now()}`;
                updateProgress(2);
                showSection('media-activation-section');
                showStatus('media-status', 'Connection failed. Using demo mode.');
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Check if both camera and screen share are active
        function checkMediaStatus() {
            const proceedButton = document.getElementById('proceed-interview');
            const cameraBtn = document.getElementById('camera-btn');
            const screenBtn = document.getElementById('screen-btn');
            
            if (proceedButton) {
                proceedButton.disabled = !(isCameraActive && isScreenShareActive);
            }

            // Update button states
            if (isCameraActive && cameraBtn) {
                cameraBtn.innerHTML = '<i class="fas fa-check"></i> Camera Active';
                cameraBtn.disabled = true;
                cameraBtn.className = 'btn btn-success';
            }

            if (isScreenShareActive && screenBtn) {
                screenBtn.innerHTML = '<i class="fas fa-check"></i> Screen Share Active';
                screenBtn.disabled = true;
                screenBtn.className = 'btn btn-success';
            }

            if (isCameraActive && isScreenShareActive) {
                showStatus('media-status', 'Both camera and screen share are active! You can now proceed.', false);
            }
        }

        // Start Camera
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 300, height: 200 },
                    audio: false
                });
                
                const cameraFeed = document.getElementById('cameraFeed');
                if (cameraFeed) {
                    cameraFeed.srcObject = cameraStream;
                    isCameraActive = true;
                    checkMediaStatus();
                    
                    // Prevent stopping camera
                    cameraStream.getVideoTracks().forEach(track => {
                        track.addEventListener('ended', () => {
                            showStatus('media-status', 'Camera is mandatory and cannot be stopped during interview!', true);
                            setTimeout(() => startCamera(), 1000);
                        });
                    });
                }
            } catch (err) {
                showStatus('media-status', `Camera access denied: ${err.message}. Please allow camera access and try again.`, true);
            }
        }

        // Start Screen Share
        async function startScreenShare() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: 300, height: 200 },
                    audio: false
                });
                
                const screenShare = document.getElementById('screenShare');
                if (screenShare) {
                    screenShare.srcObject = screenStream;
                    isScreenShareActive = true;
                    checkMediaStatus();
                    
                    // Restart screen share if user stops it
                    screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                        isScreenShareActive = false;
                        const screenBtn = document.getElementById('screen-btn');
                        if (screenBtn) {
                            screenBtn.innerHTML = '<i class="fas fa-desktop"></i> Start Screen Share';
                            screenBtn.disabled = false;
                            screenBtn.className = 'btn btn-media';
                        }
                        showStatus('media-status', 'Screen sharing stopped! Please restart it to continue.', true);
                        checkMediaStatus();
                    });
                }
            } catch (err) {
                showStatus('media-status', `Screen share failed: ${err.message}. Please try again.`, true);
            }
        }

        // Proceed to Interview
        async function proceedToInterview() {
            if (!isCameraActive || !isScreenShareActive) {
                showStatus('media-status', 'Both camera and screen share must be active to proceed!', true);
                return;
            }

            const button = event.target;
            const originalContent = showLoading(button);

            try {
                await getInterviewerIntro({
                    name: document.getElementById("name")?.value.trim() || "Candidate",
                    email: document.getElementById("email")?.value.trim() || "candidate@example.com",
                    experience: document.getElementById("experience")?.value || "1-3",
                    position: document.getElementById("position")?.value.trim() || "Analyst"
                });
                
                updateProgress(3);
                showSection('candidate-intro-section');
            } catch (err) {
                // Continue with fallback
                updateProgress(3);
                showSection('candidate-intro-section');
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Fetch and display AI interviewer introduction
        async function getInterviewerIntro(userProfile) {
            try {
                const res = await fetch(`${BASE_URL}/interview/intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(userProfile),
                    signal: AbortSignal.timeout(10000)
                });
                
                const data = await res.json();
                const introContainer = document.getElementById("intro-container");
                
                if (introContainer) {
                    const introText = data.interviewer_introduction || data.intro || 
                        `Hello ${userProfile.name}! Welcome to your Excel skills assessment. I'm your AI interviewer and I'll be evaluating your Excel knowledge through a series of practical questions. Let's begin with your introduction.`;
                    
                    introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>${introText}`;
                }
            } catch (err) {
                const introContainer = document.getElementById("intro-container");
                if (introContainer) {
                    introContainer.innerHTML = `<i class="fas fa-robot" style="color: #667eea; margin-right: 10px;"></i>Welcome to your Excel skills assessment! Please introduce yourself.`;
                }
            }
        }

        // Submit Candidate Introduction
        async function submitCandidateIntro() {
            const button = event.target;
            const originalContent = showLoading(button);

            const candidateIntro = document.getElementById("candidate-intro").value.trim();
            if (!candidateIntro) {
                showStatus('intro-status', 'Please provide your introduction.', true);
                hideLoading(button, originalContent);
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/interview/analyze-intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ introduction: candidateIntro }),
                    signal: AbortSignal.timeout(10000)
                });
                
                if (res.ok) {
                    const profile = await res.json();
                    window.candidateProfile = profile;
                }
                
                window.candidateIntroduction = candidateIntro;
                updateProgress(4);
                showSection('interview-section');
                await startInterview();
            } catch (err) {
                // Continue with fallback
                window.candidateIntroduction = candidateIntro;
                updateProgress(4);
                showSection('interview-section');
                await startInterview();
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Start Interview
        async function startInterview() {
            try {
                const candidateProfile = window.candidateProfile || null;
                const res = await fetch(`${BASE_URL}/interview/${userId}/start`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ candidate_profile: candidateProfile }),
                    signal: AbortSignal.timeout(10000)
                });

                if (res.ok) {
                    const data = await res.json();
                    currentQuestionId = data.question_id || 1;
                    const questionContainer = document.getElementById("question-container");
                    if (questionContainer) {
                        questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>${data.first_question || data.question}`;
                    }
                } else {
                    throw new Error('Failed to start interview');
                }
            } catch (err) {
                // Fallback with demo question
                currentQuestionId = 1;
                const questionContainer = document.getElementById("question-container");
                if (questionContainer) {
                    questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>Can you explain the difference between VLOOKUP and INDEX-MATCH functions in Excel? When would you use each one?`;
                }
            }
        }

        // Submit Answer
        async function submitAnswer() {
            const button = event.target;
            const originalContent = showLoading(button);

            const answer = document.getElementById("answer").value.trim();
            if (!answer) {
                showStatus('interview-status', 'Please enter your answer before submitting.', true);
                hideLoading(button, originalContent);
                return;
            }

            const payload = { question_id: currentQuestionId, user_answer: answer };
            
            try {
                const res = await fetch(`${BASE_URL}/interview/${userId}/answer`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(10000)
                });

                if (res.ok) {
                    const data = await res.json();
                    document.getElementById("answer").value = "";
                    document.getElementById("answerBox").value = "";
                    
                    if (data.finished) {
                        await showResult();
                    } else {
                        currentQuestionId = data.question_id || (currentQuestionId + 1);
                        const questionContainer = document.getElementById("question-container");
                        if (questionContainer) {
                            questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>${data.next_question || data.question}`;
                        }
                        showStatus('interview-status', 'Answer submitted! Here\'s your next question.');
                    }
                } else {
                    throw new Error('Failed to submit answer');
                }
            } catch (err) {
                // For demo, simulate next question or end
                document.getElementById("answer").value = "";
                document.getElementById("answerBox").value = "";
                
                if (currentQuestionId >= 3) {
                    await showResult();
                } else {
                    currentQuestionId++;
                    const questions = [
                        "How would you create a pivot table to analyze sales data by region and product category?",
                        "Explain how you would use conditional formatting to highlight cells that meet specific criteria.",
                        "What is the purpose of Excel's Data Validation feature and how would you implement it?"
                    ];
                    
                    const questionContainer = document.getElementById("question-container");
                    if (questionContainer && questions[currentQuestionId - 2]) {
                        questionContainer.innerHTML = `<i class="fas fa-question-circle" style="color: #f39c12; margin-right: 10px;"></i>${questions[currentQuestionId - 2]}`;
                    }
                    showStatus('interview-status', 'Answer submitted! Here\'s your next question.');
                }
            } finally {
                hideLoading(button, originalContent);
            }
        }

        // Show Final Result
        async function showResult() {
            showSection('result-section');

            try {
                const res = await fetch(`${BASE_URL}/interview/${userId}/result`, {
                    signal: AbortSignal.timeout(10000)
                });

                if (res.ok) {
                    const data = await res.json();
                    const resultOutput = document.getElementById("result-output");
                    if (resultOutput) {
                        resultOutput.innerHTML = `
                            <div class="score-display">
                                <div class="score-circle">${data.overall_score || '85'}/100</div>
                                <h3>Overall Score</h3>
                            </div>
                            <div class="result-section">
                                <h3><i class="fas fa-star" style="color: #f39c12;"></i> Strengths</h3>
                                <p>${Array.isArray(data.strengths) ? data.strengths.join(", ") : (data.strengths || 'Good understanding of Excel functions, Clear explanations')}</p>
                            </div>
                            <div class="result-section">
                                <h3><i class="fas fa-chart-line" style="color: #3498db;"></i> Areas for Growth</h3>
                                <p>${Array.isArray(data.areas_of_progress) ? data.areas_of_progress.join(", ") : (data.areas_of_progress || 'Advanced formulas, Data analysis techniques')}</p>
                            </div>
                            <div class="result-section">
                                <h3><i class="fas fa-comments" style="color: #27ae60;"></i> Detailed Feedback</h3>
                                <p>${data.feedback_summary || 'You demonstrated a solid understanding of Excel fundamentals. Continue practicing advanced features like pivot tables and complex formulas to enhance your skills further.'}</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to get results');
                }
            } catch (err) {
                // Fallback demo results
                const resultOutput = document.getElementById("result-output");
                if (resultOutput) {
                    resultOutput.innerHTML = `
                        <div class="score-display">
                            <div class="score-circle">85/100</div>
                            <h3>Overall Score</h3>
                        </div>
                        <div class="result-section">
                            <h3><i class="fas fa-star" style="color: #f39c12;"></i> Strengths</h3>
                            <p>Good understanding of Excel functions, Clear explanations, Problem-solving approach</p>
                        </div>
                        <div class="result-section">
                            <h3><i class="fas fa-chart-line" style="color: #3498db;"></i> Areas for Growth</h3>
                            <p>Advanced formulas, Data analysis techniques, Pivot table optimization</p>
                        </div>
                        <div class="result-section">
                            <h3><i class="fas fa-comments" style="color: #27ae60;"></i> Detailed Feedback</h3>
                            <p>You demonstrated a solid understanding of Excel fundamentals. Your answers showed good logical thinking. Continue practicing advanced features like pivot tables and complex formulas to enhance your skills further.</p>
                        </div>
                    `;
                }
            }
        }

        // Restart
        function restart() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            location.reload();
        }

        // Speech Recognition Functions
        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showStatus('speech-status', 'Speech recognition is not supported in your browser', true);
                return;
            }

            if (isRecording) {
                showStatus('speech-status', 'Already recording', true);
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.continuous = true;

            let finalTranscript = '';

            recognition.onstart = function() {
                isRecording = true;
                document.getElementById('recordingIndicator').classList.add('active');
                document.getElementById('start-record-btn').disabled = true;
                document.getElementById('stop-record-btn').disabled = false;
                showStatus('speech-status', 'Recording started - speak now');
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const answerBox = document.getElementById('answerBox');
                if (answerBox) {
                    answerBox.value = finalTranscript + interimTranscript;
                }
            };

            recognition.onerror = function(event) {
                showStatus('speech-status', 'Recognition error: ' + event.error, true);
                stopRecording();
            };

            recognition.onend = function() {
                isRecording = false;
                document.getElementById('recordingIndicator').classList.remove('active');
                document.getElementById('start-record-btn').disabled = false;
                document.getElementById('stop-record-btn').disabled = true;
                if (finalTranscript.trim()) {
                    showStatus('speech-status', 'Recording completed successfully');
                }
            };

            recognition.start();
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false;
                document.getElementById('recordingIndicator').classList.remove('active');
                document.getElementById('start-record-btn').disabled = false;
                document.getElementById('stop-record-btn').disabled = true;
                showStatus('speech-status', 'Recording stopped. You can now edit the answer or copy it.');
            }
        }

        function clearAnswer() {
            document.getElementById('answerBox').value = '';
            showStatus('speech-status', 'Answer cleared - ready for new recording or typing');
        }

        function copyToMainAnswer() {
            const recordedAnswer = document.getElementById('answerBox').value.trim();
            const mainAnswerField = document.getElementById('answer');
            
            if (recordedAnswer && mainAnswerField) {
                mainAnswerField.value = recordedAnswer;
                showStatus('speech-status', 'Answer copied to main answer field successfully');
            } else {
                showStatus('speech-status', 'No text to copy or answer field not found', true);
            }
        }

        // Monitor media streams
        function monitorMediaStreams() {
            if (currentStep >= 2) {
                if (!isCameraActive && cameraStream) {
                    showStatus('media-status', 'Camera stream lost! Restarting...', true);
                    startCamera();
                }
                
                if (!isScreenShareActive && currentStep >= 3) {
                    showStatus('media-status', 'Screen share is required! Please restart it.', true);
                }
            }
        }

        // Cleanup when page unloads
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            if (recognition && isRecording) {
                recognition.stop();
            }
        });

        // Prevent browser back button during interview
        window.addEventListener('popstate', function(event) {
            if (currentStep > 2) {
                history.pushState(null, null, window.location.href);
                showStatus('media-status', 'Cannot navigate back during active interview', true);
            }
        });

        // Initialize
        history.pushState(null, null, window.location.href);
        
        // Monitor media streams every 5 seconds
        setInterval(monitorMediaStreams, 5000);

        console.log('AI Excel Interview App initialized successfully');
    </script>
</body>
</html>